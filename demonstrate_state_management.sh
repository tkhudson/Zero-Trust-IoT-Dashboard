#!/bin/bash
# Terraform State Management Demonstration
# Showcases enterprise-grade state management practices

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

DEMO_DIR=$(dirname "$(realpath "$0")")

print_title() {
    local title="$1"
    echo -e "${PURPLE}"
    echo "=================================================================="
    echo "ğŸ¯ $title"
    echo "=================================================================="
    echo -e "${NC}"
}

print_section() {
    local section="$1"
    echo -e "${BLUE}"
    echo ""
    echo "â–¶ï¸  $section"
    echo "-----------------------------------------------------------"
    echo -e "${NC}"
}

pause_for_demo() {
    local message="${1:-Press ENTER to continue...}"
    echo -e "${YELLOW}â¸ï¸  $message${NC}"
    read -r
}

demonstrate_current_state() {
    print_section "Current State Analysis"
    
    echo "ğŸ“Š Analyzing current Terraform state configuration..."
    
    # Show current backend configuration
    echo -e "${BLUE}1. Backend Configuration:${NC}"
    if grep -A 10 "backend \"azurerm\"" main.tf | head -10; then
        echo -e "${YELLOW}   (Currently commented out - using local state)${NC}"
    fi
    
    # Show current workspace
    echo -e "${BLUE}2. Current Workspace:${NC}"
    terraform workspace show
    
    # Show state resources
    echo -e "${BLUE}3. Resources in State:${NC}"
    if terraform state list &> /dev/null; then
        local count=$(terraform state list | wc -l)
        echo "   Total resources: $count"
        terraform state list | head -5
        if [ $count -gt 5 ]; then
            echo "   ... and $(($count - 5)) more"
        fi
    else
        echo "   No state found or state inaccessible"
    fi
    
    pause_for_demo
}\n\ndemonstrate_state_operations() {\n    print_section \"State Operations Toolkit\"\n    \n    echo \"ğŸ”§ Demonstrating advanced state management operations...\"\n    \n    # State analysis\n    echo -e \"${BLUE}1. State Health Check:${NC}\"\n    ./scripts/state_operations.sh monitor\n    \n    pause_for_demo \"Ready to see state backup and analysis?\"\n    \n    # State backup\n    echo -e \"${BLUE}2. State Backup:${NC}\"\n    ./scripts/state_operations.sh backup\n    \n    # State analysis\n    echo -e \"${BLUE}3. State Analysis:${NC}\"\n    ./scripts/state_operations.sh analyze\n    \n    pause_for_demo\n}\n\ndemonstrate_workspace_management() {\n    print_section \"Workspace Management\"\n    \n    echo \"ğŸ¢ Demonstrating multi-environment workspace strategies...\"\n    \n    # List current workspaces\n    echo -e \"${BLUE}1. Current Workspaces:${NC}\"\n    ./scripts/state_workspace_manager.sh list\n    \n    pause_for_demo \"Ready to create development environment?\"\n    \n    # Create development workspace\n    echo -e \"${BLUE}2. Creating Development Workspace:${NC}\"\n    ./scripts/state_workspace_manager.sh create demo-dev\n    \n    # Create staging workspace\n    echo -e \"${BLUE}3. Creating Staging Workspace:${NC}\"\n    ./scripts/state_workspace_manager.sh create demo-staging\n    \n    # Show workspace comparison\n    echo -e \"${BLUE}4. Workspace Comparison:${NC}\"\n    ./scripts/state_workspace_manager.sh compare default demo-dev\n    \n    # Clean up demo workspaces\n    echo -e \"${BLUE}5. Cleaning Up Demo Workspaces:${NC}\"\n    ./scripts/state_workspace_manager.sh delete demo-dev\n    ./scripts/state_workspace_manager.sh delete demo-staging\n    \n    pause_for_demo\n}\n\ndemonstrate_remote_state_setup() {\n    print_section \"Remote State Backend Setup\"\n    \n    echo \"â˜ï¸  Demonstrating enterprise remote state configuration...\"\n    \n    echo -e \"${BLUE}Available Remote State Setup Options:${NC}\"\n    echo \"  1. Full setup (creates Azure storage + migrates state)\"\n    echo \"  2. Setup only (creates storage infrastructure)\"\n    echo \"  3. Migrate only (assumes storage exists)\"\n    echo \"  4. Monitor setup (creates monitoring tools)\"\n    echo \"\"\n    echo -e \"${YELLOW}ğŸ“‹ What the setup includes:${NC}\"\n    echo \"  âœ… Azure Blob Storage with versioning\"\n    echo \"  âœ… State locking with lease mechanism\"\n    echo \"  âœ… Encryption at rest and in transit\"\n    echo \"  âœ… RBAC access control\"\n    echo \"  âœ… Cross-region replication\"\n    echo \"  âœ… Automated backup strategies\"\n    echo \"  âœ… State monitoring and health checks\"\n    echo \"\"\n    echo -e \"${BLUE}Setup script usage:${NC}\"\n    echo \"  ./scripts/setup_remote_state.sh full    # Complete setup\"\n    echo \"  ./scripts/setup_remote_state.sh setup   # Infrastructure only\"\n    echo \"  ./scripts/setup_remote_state.sh migrate # Migration only\"\n    echo \"  ./scripts/setup_remote_state.sh monitor # Monitoring tools\"\n    \n    pause_for_demo\n}\n\ndemonstrate_state_security() {\n    print_section \"State Security Best Practices\"\n    \n    echo \"ğŸ”’ Demonstrating state security and access control...\"\n    \n    echo -e \"${BLUE}1. State File Encryption:${NC}\"\n    echo \"   âœ… Azure Storage Service Encryption (at rest)\"\n    echo \"   âœ… HTTPS encryption (in transit)\"\n    echo \"   âœ… Azure Key Vault integration (optional)\"\n    \n    echo -e \"${BLUE}2. Access Control:${NC}\"\n    echo \"   âœ… Azure RBAC for storage account access\"\n    echo \"   âœ… Service principal authentication for CI/CD\"\n    echo \"   âœ… Least privilege principle\"\n    echo \"   âœ… Access logging and monitoring\"\n    \n    echo -e \"${BLUE}3. State Integrity:${NC}\"\n    echo \"   âœ… Blob versioning for rollback capability\"\n    echo \"   âœ… Soft delete protection (30 days)\"\n    echo \"   âœ… Cross-region replication\"\n    echo \"   âœ… State validation and health checks\"\n    \n    echo -e \"${BLUE}4. Compliance Features:${NC}\"\n    echo \"   âœ… Audit logging for all state operations\"\n    echo \"   âœ… Data residency controls\"\n    echo \"   âœ… Retention policy management\"\n    echo \"   âœ… Compliance tagging and metadata\"\n    \n    pause_for_demo\n}\n\ndemonstrate_disaster_recovery() {\n    print_section \"Disaster Recovery & Business Continuity\"\n    \n    echo \"ğŸš¨ State disaster recovery and backup strategies...\"\n    \n    echo -e \"${BLUE}1. Automated Backup Strategy:${NC}\"\n    echo \"   ğŸ“… Pre-operation state snapshots\"\n    echo \"   ğŸ“… Scheduled daily backups\"\n    echo \"   ğŸ“… Cross-region backup replication\"\n    echo \"   ğŸ“… Point-in-time recovery capability\"\n    \n    echo -e \"${BLUE}2. Recovery Procedures:${NC}\"\n    echo \"   ğŸ”„ State corruption recovery\"\n    echo \"   ğŸ”„ Accidental deletion recovery\"\n    echo \"   ğŸ”„ Infrastructure region failure recovery\"\n    echo \"   ğŸ”„ Team member access revocation\"\n    \n    # Demonstrate backup listing\n    echo -e \"${BLUE}3. Current Backups:${NC}\"\n    if [ -d \"./backups/state\" ]; then\n        echo \"   Recent state backups:\"\n        ls -lht ./backups/state/ | head -5\n    else\n        echo \"   No backups found (run state operations to create)\"\n    fi\n    \n    pause_for_demo\n}\n\nshow_interview_talking_points() {\n    print_section \"Interview & Portfolio Talking Points\"\n    \n    echo \"ğŸ’¼ Key points to highlight in technical discussions...\"\n    \n    echo -e \"${BLUE}ğŸ¯ Technical Expertise:${NC}\"\n    echo \"   âœ… 'Implemented enterprise-grade Terraform state management'\"\n    echo \"   âœ… 'Configured remote state with Azure backend for team collaboration'\"\n    echo \"   âœ… 'Established state locking to prevent corruption from concurrent operations'\"\n    echo \"   âœ… 'Designed multi-environment state isolation using workspace patterns'\"\n    echo \"   âœ… 'Created automated state backup and disaster recovery procedures'\"\n    \n    echo -e \"${BLUE}ğŸ”’ Security Considerations:${NC}\"\n    echo \"   âœ… 'State files contain sensitive data - implemented encryption and RBAC'\"\n    echo \"   âœ… 'Used Azure RBAC to restrict state access to authorized personnel only'\"\n    echo \"   âœ… 'Configured service principals for CI/CD pipeline state access'\"\n    echo \"   âœ… 'Enabled comprehensive audit logging for compliance requirements'\"\n    \n    echo -e \"${BLUE}âš¡ Operational Excellence:${NC}\"\n    echo \"   âœ… 'Automated state migration scripts for environment promotion'\"\n    echo \"   âœ… 'Implemented state drift detection and remediation procedures'\"\n    echo \"   âœ… 'Created state monitoring and alerting for proactive issue resolution'\"\n    echo \"   âœ… 'Established state surgery procedures for emergency operations'\"\n    \n    echo -e \"${BLUE}ğŸ¢ Enterprise Practices:${NC}\"\n    echo \"   âœ… 'Designed workspace strategy for dev/staging/prod isolation'\"\n    echo \"   âœ… 'Implemented state versioning and rollback capabilities'\"\n    echo \"   âœ… 'Created team collaboration workflows with proper access controls'\"\n    echo \"   âœ… 'Established cost optimization through free tier state management'\"\n    \n    pause_for_demo\n}\n\nshow_implementation_guide() {\n    print_section \"Quick Implementation Guide\"\n    \n    echo \"ğŸš€ How to implement this in your own projects...\"\n    \n    echo -e \"${BLUE}Step 1: Initialize Remote State${NC}\"\n    echo \"   ./scripts/setup_remote_state.sh full\"\n    echo \"\"\n    \n    echo -e \"${BLUE}Step 2: Set Up Multi-Environment Workspaces${NC}\"\n    echo \"   ./scripts/state_workspace_manager.sh setup\"\n    echo \"\"\n    \n    echo -e \"${BLUE}Step 3: Configure Environment-Specific Variables${NC}\"\n    echo \"   # Creates terraform.tfvars.dev, terraform.tfvars.staging, etc.\"\n    echo \"   # Edit each file for environment-specific settings\"\n    echo \"\"\n    \n    echo -e \"${BLUE}Step 4: Deploy to Different Environments${NC}\"\n    echo \"   ./scripts/state_workspace_manager.sh plan dev\"\n    echo \"   ./scripts/state_workspace_manager.sh apply dev\"\n    echo \"\"\n    \n    echo -e \"${BLUE}Step 5: Monitor and Maintain State${NC}\"\n    echo \"   ./scripts/state_operations.sh monitor    # Health checks\"\n    echo \"   ./scripts/state_operations.sh backup     # Create backups\"\n    echo \"   ./scripts/state_operations.sh analyze    # Analyze state\"\n    echo \"\"\n    \n    echo -e \"${GREEN}ğŸ’¡ Pro Tips:${NC}\"\n    echo \"   â€¢ Always backup state before major operations\"\n    echo \"   â€¢ Use workspaces for environment separation\"\n    echo \"   â€¢ Monitor state health regularly\"\n    echo \"   â€¢ Implement automated backup in CI/CD\"\n    echo \"   â€¢ Use RBAC to control state access\"\n    \n    pause_for_demo\n}\n\nprint_summary() {\n    print_title \"TERRAFORM STATE MANAGEMENT DEMONSTRATION COMPLETE\"\n    \n    echo -e \"${GREEN}ğŸ‰ You now have enterprise-grade Terraform state management!${NC}\"\n    echo \"\"\n    echo -e \"${BLUE}ğŸ“ Created Files & Scripts:${NC}\"\n    echo \"   âœ… ./scripts/setup_remote_state.sh      - Remote state setup\"\n    echo \"   âœ… ./scripts/state_operations.sh        - State operations toolkit\"\n    echo \"   âœ… ./scripts/state_workspace_manager.sh - Workspace management\"\n    echo \"   âœ… ./TERRAFORM_STATE_MANAGEMENT.md      - Complete documentation\"\n    echo \"\"\n    echo -e \"${BLUE}ğŸ¯ Key Capabilities Demonstrated:${NC}\"\n    echo \"   âœ… Remote state with Azure Blob Storage\"\n    echo \"   âœ… State locking and corruption prevention\"\n    echo \"   âœ… Multi-environment workspace management\"\n    echo \"   âœ… Automated backup and recovery procedures\"\n    echo \"   âœ… State security and access control\"\n    echo \"   âœ… Comprehensive monitoring and health checks\"\n    echo \"   âœ… Enterprise-grade operational procedures\"\n    echo \"\"\n    echo -e \"${PURPLE}ğŸ’¼ Perfect for demonstrating:${NC}\"\n    echo \"   ğŸ¯ Advanced Terraform expertise\"\n    echo \"   ğŸ¯ Enterprise infrastructure practices\"\n    echo \"   ğŸ¯ Security-first DevOps approach\"\n    echo \"   ğŸ¯ Operational excellence mindset\"\n    echo \"   ğŸ¯ Team collaboration solutions\"\n    echo \"\"\n    echo -e \"${YELLOW}ğŸš€ Next Steps:${NC}\"\n    echo \"   1. Run './scripts/setup_remote_state.sh full' to implement\"\n    echo \"   2. Customize workspace configurations for your environments\"\n    echo \"   3. Integrate state monitoring into your CI/CD pipelines\"\n    echo \"   4. Use these scripts and practices in your own projects\"\n    echo \"   5. Showcase this expertise in technical interviews!\"\n    echo \"\"\n    echo -e \"${GREEN}ğŸ† Your Terraform state management skills are now interview-ready!${NC}\"\n}\n\nmain() {\n    print_title \"TERRAFORM STATE MANAGEMENT DEMONSTRATION\"\n    \n    echo -e \"${BLUE}Welcome to the comprehensive Terraform state management demo!${NC}\"\n    echo \"This demonstration showcases enterprise-grade practices for:\"\n    echo \"  ğŸ¯ Remote state configuration and management\"\n    echo \"  ğŸ¯ Multi-environment workspace strategies\"\n    echo \"  ğŸ¯ State security and access control\"\n    echo \"  ğŸ¯ Backup and disaster recovery procedures\"\n    echo \"  ğŸ¯ Operational monitoring and health checks\"\n    echo \"\"\n    echo -e \"${YELLOW}Perfect for technical interviews and portfolio presentations!${NC}\"\n    \n    pause_for_demo \"Ready to start the demonstration?\"\n    \n    # Run demonstration sections\n    demonstrate_current_state\n    demonstrate_state_operations\n    demonstrate_workspace_management\n    demonstrate_remote_state_setup\n    demonstrate_state_security\n    demonstrate_disaster_recovery\n    show_interview_talking_points\n    show_implementation_guide\n    print_summary\n    \n    echo -e \"${PURPLE}ğŸŠ Thank you for exploring Terraform state management!${NC}\"\n}\n\n# Change to project directory\ncd \"$DEMO_DIR\"\n\n# Run the demonstration\nmain